---
/**
 * Template universal para subservicios:
 * 1) Hero (h1 + description + cta + bg image)
 * 2) Paso a paso
 * 3) Por qué elegirnos (cards)
 * 4) Link Building
 * 5) FAQ
 * 6) CTA final
 */
import "../../../styles/components/GenericTemplate.css";
import RestorationCTA from "../../RestorationCTA.jsx";
import FAQ from "../../AcordeonServices.jsx";
import RegionalCoverage from "../../RegionalCoverage";
import MicroBenefits from "../../MicroBenefits.jsx";
import WhatNotToDo from "../../WhatNotToDo.jsx";

const { group, sub } = Astro.props;

// HERO
const heroTitle = sub?.hero?.title ?? sub?.title;
const heroDesc = sub?.hero?.description ?? sub?.short ?? group?.description;
const heroCTA = sub?.hero?.cta ?? "Get Help Now";

// Fallbacks por template (carpetas cortas como usas en /images/water/..)
const defaultHeroByTemplate = {
  water: "/images/herowater.jpg",
  fire: "/images/herofire.jpg",
  storm: "/images/herostorm.jpg",
  mold: "/images/heromold.jpg",
  mitigation: "/images/heromitigation.jpg",
};
const heroBg =
  sub?.hero?.bg ??
  sub?.images?.hero ??
  defaultHeroByTemplate[group?.template] ??
  "/images/placeholder-hero.jpg";

// PASO A PASO
const steps = sub?.steps ?? [
  {
    title: "Assessment",
    text: "We inspect damage and plan the response.",
    icon: "fa-solid fa-clipboard-check",
  },
  {
    title: "Mitigation",
    text: "Stop the cause and protect unaffected areas.",
    icon: "fa-solid fa-shield-halved",
  },
  {
    title: "Drying/Clean",
    text: "Extraction, dehumidification or soot cleanup.",
    icon: "fa-solid fa-wind",
  },
  {
    title: "Repair",
    text: "Structural fixes and finish work.",
    icon: "fa-solid fa-screwdriver-wrench",
  },
];

// Asegura icono por defecto
steps.forEach((s) => {
  if (!s.icon) s.icon = "fa-solid fa-circle-dot";
});

// POR QUÉ ELEGIRNOS
const reasons = sub?.reasons ?? [
  { title: "24/7 Response", text: "Rapid arrival to reduce damage." },
  { title: "Certified Team", text: "IICRC-certified professionals." },
  { title: "Insurance Help", text: "We document and coordinate claims." },
  { title: "Guaranteed Work", text: "Quality workmanship you can trust." },
];

// LINK BUILDING
const autoLinks = (group?.subservices ?? [])
  .filter((s) => s.slug !== sub.slug)
  .map((s) => ({
    href: `/restoration/${group.slug}/${s.slug}`,
    label: s.title,
  }));

const links = sub?.links && sub.links.length > 0 ? sub.links : autoLinks;

// FAQ - Transform data structure for AcordeonServices component
const rawFaqs = sub?.faqs ?? [
  { q: "How fast can you arrive?", a: "Usually within 60–90 minutes." },
  { q: "Do you work with insurance?", a: "Yes, we document and coordinate." },
];

// Convert {q, a} format to {question, answer} format for AcordeonServices
const customQuestions = rawFaqs.map((faq, index) => ({
  id: `custom-${index}`,
  question: faq.q,
  answer: faq.a,
}));

const finalCta = {
  title: sub?.cta?.headline ?? "Need help now?",
  text: sub?.cta?.text ?? "",
  cta: sub?.cta?.button ?? "Contact Us",
  href: sub?.cta?.href ?? "/contact",
};
---

<section class="hero" style={`--hero-bg: url('${heroBg}')`}>
  <div class="hero__overlay"></div>
  <div class="container hero__inner">
    <h1 class="hero__title">{heroTitle}</h1>
    <p class="hero__desc">{heroDesc}</p>
    <a href="/contact" class="btn btn--primary">{heroCTA}</a>
  </div>
</section>

<section class="steps container">
  <h2 class="section__title">Quick Relief – How It Works</h2>
  <ol class="timeline">
    {
      steps.map((s) => (
        <li class="timeline__step">
          <div class="timeline__icon">
            <i class={s.icon} />
          </div>
          <div class="timeline__content">
            <h3 class="timeline__title">{s.title}</h3>
            <p class="timeline__text">{s.text}</p>
          </div>
        </li>
      ))
    }
  </ol>
</section>

<section class="reasons container">
  <h2 class="section__title">Why choose us</h2>
  <div class="cards">
    {
      reasons.map((r) => (
        <article class="card">
          <div class="card__header">
            {r?.icon && <i class={`card__icon ${r.icon}`} aria-hidden="true" />}
            <h3 class="card__title">{r.title}</h3>
          </div>

          <p class="card__text">{r.text}</p>

          {r?.cta?.href && r?.cta?.label && (
            <a href={r.cta.href} class="btn btn--card">
              {r.cta.label}
            </a>
          )}
        </article>
      ))
    }
  </div>
</section>

<!-- Micro Benefits -->
{
  sub?.microBenefits && (
    <MicroBenefits benefits={sub.microBenefits} client:load />
  )
}

<!-- What Not To Do -->
{sub?.whatNotToDo && <WhatNotToDo items={sub.whatNotToDo} client:load />}

<section class="links container">
  <h2 class="section__title">Related services</h2>
  <ul class="links__grid">
    {
      links.map((l) => (
        <li>
          <a class="link" href={l.href}>
            {l.label}
          </a>
        </li>
      ))
    }
  </ul>
</section>

<!-- Regional Coverage -->
<RegionalCoverage client:load title="Regional Coverage" internalLinks={[]} />

<FAQ
  category={group?.template || "general"}
  customQuestions={customQuestions}
  title="FAQ"
  client:load
/>

<RestorationCTA
  title={finalCta.title}
  subtitle={finalCta.text}
  buttonText={finalCta.cta}
  buttonLink={finalCta.href}
  client:load
/>
