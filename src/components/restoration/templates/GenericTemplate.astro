---
/**
 * Template universal para subservicios - VERSIÓN FINAL CON COMPONENTES REALES
 */
import "../../../styles/components/GenericTemplate.css";
import "../../../styles/components/Risks.css";
import "../../../styles/components/Highlights.css";
import FAQ from "../../AcordeonServices.jsx";
import FloridaScenarios from "../../FloridaScenarios.jsx";
import MicroBenefits from "../../MicroBenefits.jsx";
import RegionalCoverage from "../../RegionalCoverage";
import RestorationCTA from "../../RestorationCTA.jsx";
import WhatNotToDo from "../../WhatNotToDo.jsx";
import WhyActingFast from "../../WhyActingFast.jsx";
import WhyEssential from "../../WhyEssential.jsx";
import EmergencySigns from "../../EmergencySigns.jsx";
import StormDamages from "../../StormDamages.jsx";
import WaterSigns from "../../WaterSigns.jsx";
import ServiceCards from "../../ServiceCards.jsx";
import EmergencyIncludes from "../../EmergencyIncludes.jsx";

const { group, sub } = Astro.props;

console.log("📊 DATOS RECIBIDOS:", { group: group?.slug, sub: sub?.slug });

// IMPORTACIÓN Y EJECUCIÓN DEL ENRICHER
let enrichedSub = sub;
try {
  const { enrichSubserviceContent } = await import("../../../utils/contentEnricher.js");
  console.log("✅ ENRICHER IMPORTADO CORRECTAMENTE");
  
  enrichedSub = enrichSubserviceContent(sub, group);
  console.log("✨ CONTENIDO ENRIQUECIDO:", enrichedSub?.hero?.title);
} catch (error) {
  console.error("❌ ERROR CON ENRICHER:", error);
  // Usar contenido básico si falla
  enrichedSub = sub;
}

// HERO ENRIQUECIDO
const heroTitle = enrichedSub.hero?.title || `${sub.title} Services in Florida`;
const heroDesc = enrichedSub.hero?.description || sub.short || `Professional ${sub.title.toLowerCase()} services in Florida.`;
const heroCTA = enrichedSub.hero?.cta || "Get Help Now";

// Fallbacks por template para imágenes de hero
const defaultHeroByTemplate = {
  water: "/images/herowater.jpg",
  fire: "/images/herofire.jpg",
  storm: "/images/herostorm.jpg",
  mold: "/images/heromold.jpg",
  mitigation: "/images/heromitigation.jpg",
};
const heroBg =
  enrichedSub.hero?.bg ??
  enrichedSub.images?.hero ??
  defaultHeroByTemplate[group.template] ??
  "/images/placeholder-hero.jpg";

// LINK BUILDING básico
const links = [
  { href: '/restoration/water-damage', label: 'Water Damage' },
  { href: '/restoration/fire-damage', label: 'Fire Damage' },
  { href: '/restoration/mold-remediation', label: 'Mold Remediation' },
  { href: '/restoration/storm-damage', label: 'Storm Damage' }
].filter(link => !link.href.includes(group?.slug));

// FAQ para el componente
const customQuestions = enrichedSub.faqs?.map((faq, index) => ({
  id: `custom-${index}`,
  question: faq.q,
  answer: faq.a,
})) || [];

const finalCta = {
  title: "Need Emergency Help?",
  text: "Our certified technicians are ready to respond 24/7 to protect your Florida property.",
  cta: "Get Help Now",
  href: "/contact",
};
---

<!-- HERO SECTION -->
<section class="hero" style={`--hero-bg: url('${heroBg}')`}>
  <div class="hero__overlay"></div>
  <div class="container hero__inner">
    <h1 class="hero__title">{heroTitle}</h1>
    <p class="hero__desc">{heroDesc}</p>
    <a href="/contact" class="btn btn--primary">{heroCTA}</a>
    
    <!-- Hero Icon Row -->
    {enrichedSub.hero?.iconRow && (
      <div class="hero__icon-row">
        {enrichedSub.hero.iconRow.map((item) => (
          <div class="hero__icon-item">
            <span class="hero__icon">{item.icon}</span>
            <span class="hero__icon-text">{item.text}</span>
          </div>
        ))}
      </div>
    )}
  </div>
</section>

<!-- WHY ESSENTIAL SECTION -->
{enrichedSub.whyEssential && (
  <WhyEssential whyEssential={enrichedSub.whyEssential} client:load />
)}

<!-- PROCESS SECTION -->
{enrichedSub.process && (
  <section class="steps container">
    <h2 class="section__title">{enrichedSub.process.title}</h2>
    <ol class="timeline">
      {enrichedSub.process.steps.map((step) => (
        <li class="timeline__step">
          <div class="timeline__icon">
            <i class={step.icon} />
          </div>
          <div class="timeline__content">
            <h3 class="timeline__title">{step.title}</h3>
            <p class="timeline__text">{step.text}</p>
          </div>
        </li>
      ))}
    </ol>
  </section>
)}

<!-- EMERGENCY SIGNS -->
{enrichedSub.emergencySigns && (
  <EmergencySigns emergencySigns={enrichedSub.emergencySigns} client:load />
)}

<!-- WATER SIGNS (solo para water damage) -->
{enrichedSub.waterSigns && (
  <WaterSigns waterSigns={enrichedSub.waterSigns} client:load />
)}

<!-- STORM DAMAGES (solo para storm damage) -->
{enrichedSub.stormDamages && (
  <StormDamages stormDamages={enrichedSub.stormDamages} client:load />
)}

<!-- SERVICE CARDS -->
{enrichedSub.serviceCards && (
  <ServiceCards serviceCards={enrichedSub.serviceCards} client:load />
)}

<!-- WHY ACTING FAST -->
{enrichedSub.whyActingFast && (
  <WhyActingFast whyActingFast={enrichedSub.whyActingFast} client:load />
)}

<!-- EMERGENCY INCLUDES -->
{enrichedSub.emergencyIncludes && (
  <EmergencyIncludes emergencyIncludes={enrichedSub.emergencyIncludes} client:load />
)}

<!-- HIGHLIGHTS SECTION -->
{enrichedSub.highlights && (
  <section class="highlights container">
    <h2 class="highlights__title">Service Highlights</h2>
    <ul class="highlights__list">
      {enrichedSub.highlights.map((highlight, index) => (
        <li class="highlights__item">
          <span class="highlights__icon">✓</span>
          <span class="highlights__text">{highlight}</span>
        </li>
      ))}
    </ul>
  </section>
)}

<!-- RISKS SECTION -->
{enrichedSub.risks && (
  <section class="risks container">
    <div class="risks__card">
      <h2 class="risks__title">Risks of Delaying Action</h2>
      <ul class="risks__list">
        {enrichedSub.risks.map((risk, index) => (
          <li class="risks__item">
            <span class="risks__icon" aria-hidden="true">🚫</span>
            <span class="risks__text">{risk}</span>
          </li>
        ))}
      </ul>
    </div>
  </section>
)}

<!-- MICRO BENEFITS -->
{enrichedSub.microBenefits && (
  <MicroBenefits benefits={enrichedSub.microBenefits} client:load />
)}

<!-- FLORIDA SCENARIOS -->
{enrichedSub.floridaScenarios && (
  <FloridaScenarios scenarios={enrichedSub.floridaScenarios} client:load />
)}

<!-- WHY CHOOSE US -->
{enrichedSub.whyChooseUs && (
  <section class="why-choose-us container">
    <h2 class="section__title">Why Choose Paramount Property Restoration</h2>
    <ul class="why-choose-us__list">
      {enrichedSub.whyChooseUs.map((point) => (
        <li class="why-choose-us__item">
          <span class="why-choose-us__icon">✓</span>
          <span class="why-choose-us__text">{point}</span>
        </li>
      ))}
    </ul>
  </section>
)}

<!-- WHAT NOT TO DO -->
{enrichedSub.whatNotToDo && (
  <WhatNotToDo items={enrichedSub.whatNotToDo} client:load />
)}

<!-- RELATED SERVICES -->
<section class="links container">
  <h2 class="section__title">Related Services</h2>
  <ul class="links__grid">
    {links.map((l) => (
      <li>
        <a class="link" href={l.href}>
          {l.label}
        </a>
      </li>
    ))}
  </ul>
</section>

<!-- REGIONAL COVERAGE -->
<RegionalCoverage
  client:load
  title="We Serve All of Florida"
  internalLinks={[]}
  service={group?.slug}
  subcategory={enrichedSub?.slug}
/>

<!-- FAQ -->
{customQuestions.length > 0 && (
  <FAQ
    category={group?.template || "general"}
    customQuestions={customQuestions}
    title="Frequently Asked Questions"
    client:load
  />
)}

<!-- FINAL CTA -->
<RestorationCTA
  title={finalCta.title}
  subtitle={finalCta.text}
  buttonText={finalCta.cta}
  buttonLink={finalCta.href}
  client:load
/>