---
// src/pages/restoration/[service]/[subcategory]/[ciudad].astro
import { getAllRestorationCombinations } from "../../../../data/restoration.js";
import { getEnrichedSubserviceContent } from "../../../../data/subservice-content.js";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import RestorationCTA from "../../../../components/RestorationCTA.jsx";
import FAQ from "../../../../components/AcordeonServices.jsx";
import SEOHead from "../../../../components/SEOHead.jsx";
import "../../../../styles/pages/[ciudad].css";
import "../../../../styles/pages/restoration-city.css";

// Static paths generation
export async function getStaticPaths() {
  const combinations = getAllRestorationCombinations();

  return combinations.map(({ service, subcategory, ciudad, servicioData, ciudadData, groupData }) => ({
    params: { service, subcategory, ciudad },
    props: { servicioData, ciudadData, groupData },
  }));
}

// Extract params and props
const { service, subcategory, ciudad } = Astro.params;
const { servicioData, ciudadData, groupData } = Astro.props;

// Page configuration (DETAIL: con ciudad)
const pageConfig = {
  canonical: `/restoration/${service}/${subcategory}/${ciudad}`,
  title: `${servicioData.title} in ${ciudadData.nombre}, ${ciudadData.region || 'FL'} | 24/7 Emergency Response`,
  description: servicioData.seo?.description || 
    `Emergency ${servicioData.title.toLowerCase()} services in ${ciudadData.nombre}, ${ciudadData.region}. 24/7 response, licensed technicians, insurance billing. Call (786) 602-2217 now!`,
};

// Enriched content
const subserviceContent = getEnrichedSubserviceContent(subcategory, ciudadData);

// Hero configuration
const heroConfig = {
  title: subserviceContent?.hero?.title || `${servicioData.title} in ${ciudadData.nombre}`,
  subtitle: subserviceContent?.hero?.description || 
    `Fast, reliable ${(servicioData.nombre || servicioData.title).toLowerCase()} services in ${ciudadData.nombre}, ${ciudadData.region}.`,
  ctaText: `Get Free Quote in ${ciudadData.nombre}`,
  bgImage: servicioData.hero?.bg || "/images/restoration-hero-default.jpg",
  badge: subserviceContent?.hero?.badge || null
};

// Service features
const serviceFeatures = subserviceContent?.features || [
  "24/7 emergency response team",
  "Advanced equipment & techniques", 
  "Insurance claim assistance",
  "Licensed & certified technicians"
];

// FAQs configuration
const customQuestions = (subserviceContent?.faqs || servicioData?.faqs || []).map((faq, index) => ({
  id: `faq-${index}`,
  question: faq.q ?? faq.question ?? "",
  answer: faq.a ?? faq.answer ?? "",
}));

// CTA configuration
const ctaConfig = {
  title: `Start your ${servicioData.title.toLowerCase()} in ${ciudadData.nombre}`,
  cta: `Request Your Free Estimate`,
  href: servicioData.cta?.href ?? "/contact",
};

// Nearby cities for SEO copy
const nearbyAreas = ["Weston", "Pembroke Pines", "Coral Gables", "Aventura", "Doral", "Kendall"];
---

<BaseLayout 
  title={pageConfig.title} 
  description={pageConfig.description}
>
  {/* SEO centralizado con ciudad (detalle) */}
  <SEOHead
    title={pageConfig.title}
    description={pageConfig.description}
    siteUrl="https://paramountpropertyrestoration.com"
    vertical="restoration"
    service={service}
    subservice={subcategory}
    city={ciudad}
    addressLocality={ciudadData.nombre}
    addressRegion={ciudadData.region || 'FL'}
    phone={"+1-786-602-2217"}
    isHub={false}
    businessName="Paramount Property Restoration"
    slot="head"
  />

  <!-- Hero Section -->
  <section
    class="hero-section"
    style={`background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url(${heroConfig.bgImage})`}
  >
    <div class="container">
      <div class="hero-content">
        <h1 class="hero-title">{heroConfig.title}</h1>
        <p class="hero-subtitle">{heroConfig.subtitle}</p>

        {heroConfig.badge && (
          <div class="emergency-badge">{heroConfig.badge}</div>
        )}

        <div class="hero-cta">
          <a href="/contact" class="btn-primary btn-emergency">
            {heroConfig.ctaText}
          </a>
          {servicioData.hero?.tagline && (
            <p class="hero-tagline">{servicioData.hero.tagline}</p>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Service Overview Section -->
  <section class="section service-overview">
    <div class="container">
      <div class="overview-grid">
        <div class="overview-content">
          <h2>{servicioData.title} Services You Can Trust</h2>
          <p class="overview-text">
            We deliver full-service {servicioData.title.toLowerCase()} in {ciudadData.nombre}
            with expert technicians, clean work practices, and results you can rely on.
          </p>

          <ul class="service-features">
            {serviceFeatures.map((feature) => (
              <li>
                <span class="feature-icon">✓</span>
                {feature}
              </li>
            ))}
          </ul>
        </div>

        <div class="overview-sidebar">
          <h3>Serving {ciudadData.nombre} and All of {ciudadData.region}</h3>
          <p>
            We offer {servicioData.title.toLowerCase()} in {ciudadData.nombre} and
            throughout {ciudadData.region}, including neighborhoods like {nearbyAreas.slice(0, 3).join(", ")}, 
            and {nearbyAreas[3]}.
          </p>
          <a href="/contact" class="btn-outline">
            Check Availability in Your Neighborhood →
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Service Process Section -->
  {subserviceContent?.process && (
    <section class="section bg-secondary">
      <div class="container">
        <h2 class="section-title">{subserviceContent.process.title}</h2>
        <div class="steps-container">
          {subserviceContent.process.steps.map((step, index) => (
            <div class="step-item" data-step={index + 1}>
              <div class="step-icon">
                <i class={step.icon}></i>
              </div>
              <h3>{step.title}</h3>
              <p>{step.text}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Services Grid -->
  {subserviceContent?.services && (
    <section class="section">
      <div class="container">
        <h2 class="section-title">Our {servicioData.title} Services in {ciudadData.nombre}</h2>
        <div class="services-grid">
          {subserviceContent.services.map((service) => (
            <div class="service-item">
              <i class={service.icon}></i>
              <h3>{service.title}</h3>
              <p>{service.description}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- FAQ Section -->
  <FAQ
    category={groupData.template || "general"}
    customQuestions={customQuestions}
    title={`Frequently Asked Questions About ${servicioData.title} in ${ciudadData.nombre}`}
    client:load
  />

  <!-- CTA Section -->
  <RestorationCTA
    title={ctaConfig.title}
    subtitle={`Expert ${servicioData.title.toLowerCase()} services available 24/7 in ${ciudadData.nombre} and throughout ${ciudadData.region}.`}
    buttonText={ctaConfig.cta}
    buttonLink={ctaConfig.href}
    client:load
  />
</BaseLayout>